<!DOCTYPE html>
<html>
<head>
    <title>ADA Slope Compliance Tool - Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body { 
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
            margin: 20px; 
            background: #f8f9fa;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #1a73e8; 
            text-align: center; 
            margin-bottom: 30px;
        }
        .description {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            border-left: 4px solid #1976d2;
        }
        #diagram { 
            text-align: center; 
            margin: 20px 0;
        }
        .legend {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .legend-item {
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .frontend { background: #e1f5fe; border-left: 4px solid #0277bd; }
        .api { background: #f3e5f5; border-left: 4px solid #7b1fa2; }
        .compute { background: #e8f5e8; border-left: 4px solid #2e7d32; }
        .storage { background: #fff3e0; border-left: 4px solid #ef6c00; }
        .cicd { background: #fce4ec; border-left: 4px solid #c2185b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ï¸ ADA Slope Compliance Tool - AWS MVP Architecture</h1>
        
        <div class="description">
            <h3>ğŸ“‹ Architecture Overview</h3>
            <p><strong>Goal:</strong> Serverless DEM processing API with static frontend, infrastructure as code, and automated CI/CD.</p>
            <p><strong>Tech Stack:</strong> FastAPI + Lambda Container, API Gateway, S3, Terraform, GitHub Actions</p>
            <p><strong>Processing:</strong> True DEM slope computation using numpy gradients with ADA compliance thresholds (5% running, 2.083% cross)</p>
        </div>

        <div id="diagram"></div>

        <div class="legend">
            <div class="legend-item frontend">
                <strong>ğŸŒ Frontend Layer</strong><br>
                Static S3 hosting, HTML5 file upload
            </div>
            <div class="legend-item api">
                <strong>âš¡ API Layer</strong><br>
                HTTP API Gateway, CORS, routing
            </div>
            <div class="legend-item compute">
                <strong>ğŸ³ Compute Layer</strong><br>
                Lambda containers, FastAPI, rasterio
            </div>
            <div class="legend-item storage">
                <strong>ğŸ“¦ Storage Layer</strong><br>
                DynamoDB, S3 (future implementation)
            </div>
            <div class="legend-item cicd">
                <strong>ğŸ”„ CI/CD Pipeline</strong><br>
                GitHub Actions, automated testing & deployment
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });

        const mermaidCode = `graph TB
    %% User and External Services
    USER[ğŸ‘¤ User] 
    GITHUB[ğŸ™ GitHub Repository]
    
    %% Frontend Layer
    subgraph "Frontend (S3 Static Hosting)"
        FE[ğŸ“„ index.html<br/>Upload Interface]
    end
    
    %% API Layer
    subgraph "API Gateway"
        APIGW[ğŸŒ HTTP API Gateway<br/>CORS Enabled<br/>$default stage]
    end
    
    %% Compute Layer
    subgraph "AWS Lambda"
        LAMBDA[ğŸ³ Container Image<br/>FastAPI + Mangum<br/>Python 3.11<br/>Memory: 1024MB<br/>Timeout: 60s]
    end
    
    %% Processing Layer
    subgraph "Lambda Runtime"
        APP[âš¡ FastAPI App<br/>POST /upload<br/>GET /status/{id}<br/>GET /results/{id}]
        PROC[ğŸ—ºï¸ DEM Processing<br/>rasterio + numpy<br/>np.gradient slope calc<br/>ADA threshold check]
    end
    
    %% Storage Layer (Future)
    subgraph "Storage (Future Implementation)"
        DDB[(ğŸ—„ï¸ DynamoDB<br/>Job State<br/>Pay-per-request)]
        S3STORE[(ğŸ“¦ S3 Bucket<br/>Result Artifacts<br/>Large DEMs)]
    end
    
    %% Container Registry
    subgraph "Container Infrastructure"
        ECR[ğŸ“‹ ECR Repository<br/>ada-slope-api<br/>Docker Images]
    end
    
    %% CI/CD Pipeline
    subgraph "CI/CD (GitHub Actions)"
        PYCI[ğŸ” Python CI<br/>ruff, black, mypy<br/>pytest coverage]
        BUILD[ğŸ—ï¸ ECR Build<br/>Docker build/push<br/>On tags (v*)]
        TFPLAN[ğŸ“‹ Terraform Plan<br/>Infrastructure validation<br/>On PRs]
    end
    
    %% Infrastructure as Code
    subgraph "Infrastructure (Terraform)"
        TF[ğŸ—ï¸ Terraform<br/>AWS Provider â‰¥5.x<br/>ECR + Lambda + API GW<br/>+ S3 + DynamoDB]
    end
    
    %% User Flow
    USER -->|1. Upload DEM GeoTIFF| FE
    FE -->|2. POST /upload| APIGW
    APIGW -->|3. Invoke| LAMBDA
    LAMBDA --> APP
    APP --> PROC
    PROC -->|4. Process with rasterio| APP
    APP -->|5. Return job_id| APIGW
    APIGW -->|6. JSON Response| FE
    FE -->|7. GET /results/{id}| APIGW
    APIGW -->|8. Fetch results| LAMBDA
    LAMBDA -->|9. ADA compliance data| FE
    FE -->|10. Display results| USER
    
    %% CI/CD Flow
    GITHUB -->|Push/PR| PYCI
    GITHUB -->|Tag v*| BUILD
    BUILD -->|Push image| ECR
    ECR -->|Image URI| LAMBDA
    GITHUB -->|PR to infra/| TFPLAN
    TF -->|Deploy| APIGW
    TF -->|Deploy| LAMBDA
    TF -->|Deploy| DDB
    TF -->|Deploy| S3STORE
    
    %% Future Connections (Dashed)
    LAMBDA -.->|Future: Persist jobs| DDB
    LAMBDA -.->|Future: Store large results| S3STORE
    
    %% Styling
    classDef frontend fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef api fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef compute fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef storage fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef cicd fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef future fill:#f5f5f5,stroke:#9e9e9e,stroke-width:1px,stroke-dasharray: 5 5
    
    class FE frontend
    class APIGW api
    class LAMBDA,APP,PROC compute
    class ECR,TF compute
    class DDB,S3STORE future
    class PYCI,BUILD,TFPLAN cicd`;

        document.getElementById('diagram').innerHTML = '<div class="mermaid">' + mermaidCode + '</div>';
    </script>
</body>
</html>
